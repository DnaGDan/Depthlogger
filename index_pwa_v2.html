<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brownfield Solutions Depth-to-Water Logger PWA — High Contrast</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <meta name="theme-color" content="#0b3ea2" />

  <!-- High-contrast refresh; plus robust JS (fixed malformed fragments) -->

  <style>
    /* ---------- Design tokens ---------- */
    :root {
      /* Dark (default) */
      --bg: #0b1020;
      --fg: #eef4ff;
      --muted: #a8b3cf;
      --card: #121a33;
      --border: #2a3a66;
      --accent: #0b66c2; /* darker blue for > 4.5 contrast on white/near-white */
      --accent-contrast: #ffffff;
      --danger: #b91c1c;
      --success: #0f766e;
      --warning: #a16207;

      --btn-bg: var(--accent);
      --btn-fg: var(--accent-contrast);
      --btn-bg-hover: #084f98;
      --btn-border: transparent;

      --input-bg: #0f1530;
      --input-fg: var(--fg);
      --input-border: #3a4a7a;
      --input-placeholder: #7b88a8;
      --focus-ring: #7aa9f6;

      --table-head-bg: #182245;
      --table-row-odd: #121a33;
      --table-row-even: #0f1730;

      --link: #8ab4ff;
      --shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    }

    .theme-light {
      --bg: #ffffff;
      --fg: #101423;
      --muted: #4b5568;
      --card: #f8fafc;
      --border: #d3d9e4;
      --accent: #0b3ea2; /* dark enough on white */
      --accent-contrast: #ffffff;

      --btn-bg: var(--accent);
      --btn-fg: var(--accent-contrast);
      --btn-bg-hover: #082f7a;
      --btn-border: transparent;

      --input-bg: #ffffff;
      --input-fg: var(--fg);
      --input-border: #9aa7bd;
      --input-placeholder: #6b7280;
      --focus-ring: #0b66c2;

      --table-head-bg: #e6eefc;
      --table-row-odd: #ffffff;
      --table-row-even: #f2f6ff;

      --link: #0b66c2;
      --shadow: 0 8px 20px rgba(16, 20, 35, 0.08);
    }

    /* ---------- Base reset ---------- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.4;
    }

    img { max-width: 100%; height: auto; }

    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Card sections */
    .section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin: 14px 0;
      box-shadow: var(--shadow);
    }

    /* ---------- Header ---------- */
    #logo { max-width: 160px; display: block; margin: 8px auto 12px; }
    h1 {
      margin: 4px 0 8px;
      text-align: center;
      font-size: clamp(18px, 2.4vw, 24px);
      font-weight: 700;
      letter-spacing: 0.01em;
      color: var(--fg);
    }

    /* Theme toggle row */
    .row { display: flex; align-items: center; gap: 8px; }
    .row label { display: inline-flex; gap: 8px; align-items: center; cursor: pointer; }

    /* ---------- Buttons ---------- */
    button {
      appearance: none;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-fg);
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      transition: transform 0.06s ease, background 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 1px 0 rgba(0,0,0,0.12);
    }
    button:hover { background: var(--btn-bg-hover); }
    button:active { transform: translateY(1px); }
    button:focus-visible {
      outline: 3px solid var(--focus-ring);
      outline-offset: 2px;
    }

    /* High-contrast disabled: keep legible text */
    button:disabled,
    .btn[disabled] {
      background: #94a3b8; /* slate-400 */
      color: #0b1020;      /* very dark text for contrast */
      border-color: #64748b;
      cursor: not-allowed;
      filter: none;
      opacity: 1;
    }

    /* Secondary, ghost & danger styles for semantic clarity */
    .btn-ghost {
      background: transparent;
      border-color: var(--border);
      color: var(--fg);
    }
    .btn-ghost:hover { background: rgba(127, 146, 190, 0.14); }
    .btn-danger { background: var(--danger); }
    .btn-danger:hover { background: #991b1b; }

    /* ---------- Inputs ---------- */
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--input-fg);
      outline: none;
      font-size: 16px;
    }
    input::placeholder, textarea::placeholder { color: var(--input-placeholder); }
    input:focus, select:focus, textarea:focus {
      border-color: var(--focus-ring);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus-ring) 25%, transparent);
    }
    input:disabled, textarea:disabled, select:disabled {
      background: color-mix(in srgb, var(--input-bg) 70%, #888 30%);
      color: color-mix(in srgb, var(--input-fg) 80%, #000 20%);
    }

    label { font-weight: 600; color: var(--fg); }

    /* ---------- Timer / Clock ---------- */
    #timer {
      font-size: clamp(28px, 7.5vw, 56px); /* large and legible */
      font-weight: 800;
      letter-spacing: 0.02em;
      text-align: center;
    }

    /* ---------- Table ---------- */
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
    thead th {
      background: var(--table-head-bg);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tbody tr:nth-child(odd) { background: var(--table-row-odd); }
    tbody tr:nth-child(even) { background: var(--table-row-even); }

    /* ---------- Parameters panel (off-canvas) ---------- */
    #parameters {
      position: fixed;
      top: 0;
      right: 0;
      width: min(360px, 92vw);
      height: 100%;
      background: var(--card);
      border-left: 1px solid var(--border);
      padding: 16px;
      transform: translateX(110%); /* fully off-screen by default */
      transition: transform 0.28s ease;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    #parameters.open { transform: translateX(0); }

    #parametersToggle {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1001;
    }
    /* Hide the floating toggle while the panel is open to avoid overlap */
    .panel-open #parametersToggle { display: none; }

    /* Utility */
    .muted { color: var(--muted); font-weight: 500; }
    .stack { display: grid; gap: 10px; }
    .grid-2 { display: grid; gap: 10px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }

    /* Microcopy */
    .hint { margin: 6px 0 0; font-size: 0.925rem; color: var(--muted); }
  </style>

  <!-- Keep the existing theme variables hook for JS toggling -->
  <style>
    #clock, #clockDisplay, .clock-display {
      font-size: clamp(24px, 6vw, 48px);
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .params-panel { transition: transform .3s ease, opacity .2s ease; will-change: transform, opacity; }
    .params-closed { transform: translateX(-120%); opacity: 0; pointer-events: none; visibility: hidden; }
    #micButton.listening, .mic-button.listening { position: relative; box-shadow: 0 0 0 4px rgba(255,0,0,.15); }
    #micButton.listening::after, .mic-button.listening::after { content: ""; position: absolute; right: -6px; top: -6px; width: 10px; height: 10px; border-radius: 50%; background: #e11; animation: pulse 1s infinite; }
    @keyframes pulse { 0%{transform:scale(.8); opacity:.6} 50%{transform:scale(1); opacity:1} 100%{transform:scale(.8); opacity:.6} }
  </style>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
</head>
<body>
  <img id="logo" src="./brownfield_logo.png" alt="Brownfield Solutions Logo" />
  <h1>Depth-to-Water Logger</h1>

  <div class="row" style="margin: 4px 0 12px;">
    <label title="Switch between light and dark for visibility in sun or in trenches.">
      <input type="checkbox" id="themeToggle" />
      <span class="muted">Light theme</span>
    </label>
  </div>

  <button id="parametersToggle" class="btn-ghost">⚙️ Parameters</button>

  <div class="section" id="parameters">
    <div class="row" style="justify-content: space-between; gap: 8px;">
      <h2 style="margin: 0;">Test Parameters</h2>
      <button id="parametersClose" class="btn-ghost">Close</button>
    </div>
    <p class="muted" style="margin-top: 6px;">All dimensions in millimetres (mm). Bottom mirrors Top until edited.</p>

    <div class="stack" style="margin-top: 10px;">
      <div class="grid-2">
        <label>Location ID <input type="text" id="locationId" placeholder="e.g., TP03" /></label>
        <label>Test Number <input type="text" id="testNumber" placeholder="e.g., Test 1" /></label>
      </div>
      <div class="grid-2">
        <label>Length at Top <input type="number" id="lengthTop" placeholder="e.g., 2000" /></label>
        <label>Length at Bottom <input type="number" id="lengthBottom" placeholder="Mirrors top" /></label>
      </div>
      <div class="grid-2">
        <label>Width at Top <input type="number" id="widthTop" placeholder="e.g., 600" /></label>
        <label>Width at Bottom <input type="number" id="widthBottom" placeholder="Mirrors top" /></label>
      </div>
      <div class="grid-2">
        <label>Depth Tested (Head of Water)
          <input type="number" id="depthTested" readonly placeholder="Calculated" />
        </label>
        <label>Depth of Excavation
          <input type="number" id="depthExcavation" placeholder="e.g., 2000" />
        </label>
      </div>
      <div>
        <label>Void Ratio</label>
        <div class="grid-2">
          <select id="voidRatio">
            <option value="1">Open (1)</option>
            <option value="0.3">Single size stone (0.3)</option>
            <option value="">Other</option>
          </select>
          <input type="number" id="voidRatioOther" placeholder="Custom value" style="display: none;" />
        </div>
      </div>
      <div class="grid-2">
        <label>Strata Description <textarea id="strataDescription" placeholder="Sand over clay..."></textarea></label>
        <label>Pit Details <textarea id="pitDetails" placeholder="Benched sides, shored, etc."></textarea></label>
      </div>
      <p class="hint">Typical pit ≈ 2000 × 600 × 2000 mm.</p>
    </div>
  </div>

  <div class="section" id="timerSection">
    <div id="timer">00:00:00</div>
    <div class="row" style="flex-wrap: wrap; gap: 8px; margin-top: 10px;">
      <button id="startPauseBtn" disabled>Start</button>
      <button id="stopTimer" disabled class="btn-danger">Stop</button>
      <button id="clearCurrent" class="btn-ghost">Clear Current Test</button>
    </div>
    <p class="hint">Timer rounds to the nearest second. Times are exported as decimal minutes (2 dp).</p>
  </div>

  <div class="section" id="recordSection">
    <div class="grid-2">
      <label>Depth to Water (mm) <input type="number" id="depthInput" placeholder="Enter depth" /></label>
      <div class="stack">
        <span class="muted">Voice input (Chrome):</span>
        <button id="speechButton" title="Use speech recognition">🎤 Speak depth</button>
      </div>
    </div>
    <div class="row" style="gap: 16px; margin-top: 8px;">
      <span>25% fall: <strong id="fall25">—</strong> mm</span>
      <span>75% fall: <strong id="fall75">—</strong> mm</span>
    </div>
    <p class="hint">Press Enter inside the field to record instantly.</p>
  </div>

  <div class="section" id="dataTable">
    <div class="row" style="justify-content: space-between; align-items: baseline;">
      <strong>Readings</strong>
      <span class="muted">Points: <span id="pointsCount">0</span></span>
    </div>
    <div style="overflow: auto; margin-top: 10px; border: 1px solid var(--border); border-radius: 10px;">
      <table id="pointsTable">
        <thead>
          <tr>
            <th>Clock time</th>
            <th>Time (mins)</th>
            <th>Depth to water (mm)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="gap: 8px; margin-top: 10px; flex-wrap: wrap;">
      <button id="undoButton" class="btn-ghost">Undo last</button>
      <button id="exportButton">Export CSV</button>
    </div>
  </div>

  <div class="section" id="savedTests">
    <div class="row" style="justify-content: space-between; align-items: baseline;">
      <h2 style="margin: 0;">Saved Tests</h2>
      <button id="saveCurrent">Save Current Test</button>
    </div>
    <ul id="testsList" style="margin-top: 8px;"></ul>
  </div>

  <p class="hint">File name includes Location ID &amp; Test Number. Speech input works best in Chrome (desktop/mobile).</p>

  <script>
    'use strict';

    // Core variables
    let timerInterval;
    let startTime;
    let pausedTime = 0;
    let pauseStart;
    let isPaused = false; // true when timer paused
    let points = [];
    let currentTestId = null;
    let lengthBottomIndependent = false;
    let widthBottomIndependent = false;
    let testStarted = false;

    // Local Storage Keys
    const STORAGE_KEY = 'depthLoggerTests';
    const CURRENT_KEY = 'depthLoggerCurrent';

    function filledCell(cell) { return cell !== '' && cell != null; }

    // Load saved tests
    function loadSavedTests() {
      const tests = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const list = document.getElementById('testsList');
      list.innerHTML = '';
      tests.forEach(test => {
        const li = document.createElement('li');
        const loc = test.locationId || 'Unknown ID';
        const num = test.testNumber || 'Unknown Number';
        let ts;
        if (test.savedAt) {
          ts = new Date(test.savedAt);
        } else if (test.id && !isNaN(Number(test.id))) {
          ts = new Date(Number(test.id));
        }
        const when = ts && !isNaN(ts.getTime()) ? ts.toLocaleString() : 'Unknown time';
        li.innerHTML = `${loc} - ${num} — ${when} <button class="btn-ghost" onclick="loadTest('${test.id}')">Load</button> <button class="btn-danger" onclick="deleteTest('${test.id}')">Delete</button>`;
        list.appendChild(li);
      });
    }

    // Save current test to local storage (auto-save on changes)
    function autoSaveCurrent() {
      const current = getCurrentData();
      localStorage.setItem(CURRENT_KEY, JSON.stringify(current));
    }

    // Save as a new or update existing test (single entry per test id; timestamp refreshed)
    function saveTest() {
      let tests = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const data = getCurrentData();
      const nowIso = new Date().toISOString();
      data.savedAt = nowIso;
      if (!currentTestId) {
        currentTestId = Date.now().toString();
        data.id = currentTestId;
        tests.push(data);
      } else {
        const index = tests.findIndex(t => t.id === currentTestId);
        if (index !== -1) {
          tests[index] = { ...tests[index], ...data, id: currentTestId, savedAt: nowIso };
        } else {
          data.id = currentTestId;
          tests.push(data);
        }
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tests));
      loadSavedTests();
      const loc = data.locationId || 'Unknown ID';
      const num = data.testNumber || 'Unknown Number';
      const when = new Date(nowIso).toLocaleString();
      alert(`Saved: ${loc} - ${num} — ${when}`);
    }

    // Load a test
    window.loadTest = function(id) {
      const tests = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const test = tests.find(t => t.id === id);
      if (!test) return;
      currentTestId = id;
      setCurrentData(test);
      testStarted = !!(test.testStarted || (test.points && test.points.length > 0));
      updateTable();
      calculateFalls();
      updateDepthTested();
      autoSaveCurrent();
      lengthBottomIndependent = !!test.lengthBottom;
      widthBottomIndependent = !!test.widthBottom;
      document.getElementById('lengthBottom').value = test.lengthBottom || test.lengthTop;
      document.getElementById('widthBottom').value = test.widthBottom || test.widthTop;
      loadTimerState();
      updateUIState();
      checkStartButton();
    }

    // Delete a test
    window.deleteTest = function(id) {
      let tests = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      tests = tests.filter(t => t.id !== id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tests));
      if (currentTestId === id) resetForm();
      loadSavedTests();
    }

    // Get current form data
    function getCurrentData() {
      return {
        id: currentTestId,
        locationId: document.getElementById('locationId').value,
        testNumber: document.getElementById('testNumber').value,
        lengthTop: document.getElementById('lengthTop').value,
        lengthBottom: document.getElementById('lengthBottom').value,
        widthTop: document.getElementById('widthTop').value,
        widthBottom: document.getElementById('widthBottom').value,
        depthTested: document.getElementById('depthTested').value,
        depthExcavation: document.getElementById('depthExcavation').value,
        voidRatio: document.getElementById('voidRatio').value || document.getElementById('voidRatioOther').value,
        strataDescription: document.getElementById('strataDescription').value,
        pitDetails: document.getElementById('pitDetails').value,
        points: points,
        testStarted: testStarted
      };
    }

    // Set form data
    function setCurrentData(data) {
      document.getElementById('locationId').value = data.locationId || '';
      document.getElementById('testNumber').value = data.testNumber || '';
      document.getElementById('lengthTop').value = data.lengthTop || '';
      document.getElementById('lengthBottom').value = data.lengthBottom || data.lengthTop || '';
      document.getElementById('widthTop').value = data.widthTop || '';
      document.getElementById('widthBottom').value = data.widthBottom || data.widthTop || '';
      document.getElementById('depthTested').value = data.depthTested || '';
      document.getElementById('depthExcavation').value = data.depthExcavation || '';
      if (data.voidRatio === '1' || data.voidRatio === '0.3') {
        document.getElementById('voidRatio').value = data.voidRatio;
        document.getElementById('voidRatioOther').style.display = 'none';
      } else if (data.voidRatio) {
        document.getElementById('voidRatio').value = '';
        document.getElementById('voidRatioOther').value = data.voidRatio;
        document.getElementById('voidRatioOther').style.display = 'block';
      } else {
        document.getElementById('voidRatio').value = '1';
        document.getElementById('voidRatioOther').style.display = 'none';
        document.getElementById('voidRatioOther').value = '';
      }
      document.getElementById('strataDescription').value = data.strataDescription || '';
      document.getElementById('pitDetails').value = data.pitDetails || '';
      points = data.points || [];
    }

    // Reset form
    function resetForm() {
      currentTestId = null;
      points = [];
      lengthBottomIndependent = false;
      widthBottomIndependent = false;
      testStarted = false;
      setCurrentData({});
      document.getElementById('lengthBottom').value = '';
      document.getElementById('widthBottom').value = '';
      document.getElementById('depthTested').value = '';
      updateTable();
      calculateFalls();
      localStorage.removeItem(CURRENT_KEY);
      // Reset timer
      document.getElementById('timer').textContent = '00:00:00';
      startTime = undefined;
      pausedTime = 0;
      pauseStart = undefined;
      isPaused = false;
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      updateUIState();
      checkStartButton();
    }

    // Update UI state
    function updateUIState() {
      document.getElementById('locationId').disabled = testStarted;
      document.getElementById('testNumber').disabled = testStarted;
      document.getElementById('stopTimer').disabled = points.length === 0;
    }

    // Check Start button state
    function checkStartButton() {
      const locationId = document.getElementById('locationId').value.trim();
      const testNumber = document.getElementById('testNumber').value.trim();
      const lengthTop = document.getElementById('lengthTop').value.trim();
      const widthTop = document.getElementById('widthTop').value.trim();
      const depthExcavation = document.getElementById('depthExcavation').value.trim();
      const btn = document.getElementById('startPauseBtn');
      if (!testStarted) {
        btn.disabled = !locationId || !testNumber || !lengthTop || !widthTop || !depthExcavation;
        btn.textContent = 'Start';
      } else {
        btn.disabled = false; // allow pausing/resuming once started
        btn.textContent = isPaused ? 'Start' : 'Pause';
      }
    }

    // Timer functions
    function updateTimer() {
      const now = isPaused ? pauseStart : Date.now();
      const elapsed = now - startTime - pausedTime;
      const seconds = Math.round(elapsed / 1000);
      const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
      const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      document.getElementById('timer').textContent = `${h}:${m}:${s}`;
    }

    // Single Start/Pause toggle
    document.getElementById('startPauseBtn').addEventListener('click', () => {
      if (!startTime) {
        // start
        startTime = Date.now();
        pausedTime = 0;
        isPaused = false;
        testStarted = true;
        timerInterval = setInterval(updateTimer, 1000);
      } else if (isPaused) {
        // resume
        pausedTime += Date.now() - pauseStart;
        isPaused = false;
        timerInterval = setInterval(updateTimer, 1000);
      } else {
        // pause
        clearInterval(timerInterval);
        pauseStart = Date.now();
        isPaused = true;
        updateTimer();
      }
      updateUIState();
      checkStartButton();
    });

    // Stop
    document.getElementById('stopTimer').addEventListener('click', () => {
      if (!confirm('Confirm end of test? This will stop the timer and auto-export the CSV.')) return;
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      pausedTime = 0;
      isPaused = false;
      startTime = undefined;
      pauseStart = undefined;
      document.getElementById('timer').textContent = '00:00:00';
      exportCSV();
      testStarted = false;
      checkStartButton();
      updateUIState();
    });

    // Load timer state to paused at latest time
    function loadTimerState() {
      const btn = document.getElementById('startPauseBtn');
      if (points.length > 0) {
        const lastTimeMins = parseFloat(points[points.length - 1].timeMins);
        const lastElapsedMs = lastTimeMins * 60 * 1000;
        startTime = Date.now();
        pausedTime = -lastElapsedMs;
        pauseStart = Date.now();
        isPaused = true;
        testStarted = true;
        timerInterval = null;
        updateTimer();
        if (btn) btn.textContent = 'Start';
      } else {
        document.getElementById('timer').textContent = '00:00:00';
        startTime = undefined;
        pausedTime = 0;
        pauseStart = undefined;
        isPaused = false;
        testStarted = false;
        if (btn) btn.textContent = 'Start';
      }
    }

    // Record point
    function recordPoint() {
      const depth = parseFloat(document.getElementById('depthInput').value);
      if (isNaN(depth)) return;
      const clockTime = new Date().toLocaleTimeString();
      const now = isPaused ? pauseStart : Date.now();
      const elapsed = (now - startTime - pausedTime) / 1000 / 60;
      const timeMins = elapsed.toFixed(2);
      points.push({ clockTime, timeMins, depth });
      if (points.length === 1) updateDepthTested();
      updateTable();
      calculateFalls();
      document.getElementById('depthInput').value = '';
      autoSaveCurrent();
      updateUIState();
    }

    document.getElementById('recordButton')?.addEventListener('click', recordPoint);
    document.getElementById('depthInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') recordPoint();
    });

    // Update table (latest at top)
    function updateTable() {
      const tbody = document.getElementById('pointsTable').querySelector('tbody');
      tbody.innerHTML = '';
      points.slice().reverse().forEach(point => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${point.clockTime}</td><td>${point.timeMins}</td><td>${point.depth}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pointsCount').textContent = points.length;
    }

    // Calculate 25% and 75% falls
    function calculateFalls() {
      if (points.length < 1) {
        document.getElementById('fall25').textContent = '—';
        document.getElementById('fall75').textContent = '—';
        return;
      }
      const initialDepth = points[0].depth;
      const fall25 = initialDepth * 0.25;
      const fall75 = initialDepth * 0.75;
      document.getElementById('fall25').textContent = fall25.toFixed(2);
      document.getElementById('fall75').textContent = fall75.toFixed(2);
    }

    // Update Depth Tested
    function updateDepthTested() {
      if (points.length > 0) {
        const exc = parseFloat(document.getElementById('depthExcavation').value) || 0;
        const firstDepth = points[0].depth;
        document.getElementById('depthTested').value = exc - firstDepth;
      } else {
        document.getElementById('depthTested').value = '';
      }
    }

    // Undo last
    document.getElementById('undoButton').addEventListener('click', () => {
      if (points.length === 0) return;
      points.pop();
      updateTable();
      calculateFalls();
      updateDepthTested();
      autoSaveCurrent();
      updateUIState();
    });

    // CSV builder (pure) — used by exportCSV and tests
    function buildCSVString(data, pts) {
      const rows = [
        'Test Parameters',
        `Location ID,${data.locationId || ''}`,
        `Test Number,${data.testNumber || ''}`,
        `Length at Top (mm),${data.lengthTop || ''}`,
        `Length at Bottom (mm),${data.lengthBottom || data.lengthTop || ''}`,
        `Width at Top (mm),${data.widthTop || ''}`,
        `Width at Bottom (mm),${data.widthBottom || data.widthTop || ''}`,
        `Depth Tested (mm),${data.depthTested || ''}`,
        `Depth of Excavation (mm),${data.depthExcavation || ''}`,
        `Void Ratio,${data.voidRatio || ''}`,
        `Strata Description,${(data.strataDescription || '').replace(/\n/g,' ')}`,
        `Pit Details,${(data.pitDetails || '').replace(/\n/g,' ')}`,
        '',
        'Data',
        'Clock time (local),Time (mins),Depth to water (mm)'
      ];
      pts.forEach(p => rows.push(`${p.clockTime},${p.timeMins},${p.depth}`));
      return rows.join('\n');
    }

    // Export CSV (uses builder)
    function exportCSV() {
      const data = getCurrentData();
      const csv = buildCSVString(data, points);
      const locationId = data.locationId || 'unknown';
      const testNumber = data.testNumber || 'unknown';
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${locationId}_${testNumber}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('exportButton').addEventListener('click', exportCSV);

    // Clear current
    document.getElementById('clearCurrent').addEventListener('click', () => {
      if (confirm('Clear current test data?')) resetForm();
    });

    // Void ratio other
    document.getElementById('voidRatio').addEventListener('change', (e) => {
      const other = document.getElementById('voidRatioOther');
      if (e.target.value === '') {
        other.style.display = 'block';
      } else {
        other.style.display = 'none';
        other.value = '';
      }
      autoSaveCurrent();
    });

    // Bottom tracking top
    function trackBottom(idTop, idBottom, independentFlag) {
      const top = document.getElementById(idTop);
      const bottom = document.getElementById(idBottom);
      top.addEventListener('input', () => {
        if (!window[independentFlag]) bottom.value = top.value;
        autoSaveCurrent();
        checkStartButton();
      });
      bottom.addEventListener('input', () => {
        window[independentFlag] = true;
        autoSaveCurrent();
      });
    }
    trackBottom('lengthTop', 'lengthBottom', 'lengthBottomIndependent');
    trackBottom('widthTop', 'widthBottom', 'widthBottomIndependent');

    // Slide-out panel (uses transform so it fully disappears when closed)
    document.getElementById('parametersToggle').addEventListener('click', () => {
      document.getElementById('parameters').classList.add('open');
      document.body.classList.add('panel-open');
    });
    document.getElementById('parametersClose').addEventListener('click', () => {
      document.getElementById('parameters').classList.remove('open');
      document.body.classList.remove('panel-open');
    });

    // Speech recognition
    const speechButton = document.getElementById('speechButton');
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      speechButton.addEventListener('click', () => {
        const recognition = new SpeechRecognition();
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById('depthInput').value = parseFloat(transcript);
          recordPoint();
        };
        recognition.start();
      });
    } else {
      speechButton.disabled = true;
      speechButton.title = 'Speech recognition not supported';
    }

    // Save current button
    document.getElementById('saveCurrent').addEventListener('click', saveTest);

    // ------- Theme persistence (export applyTheme for tests) -------
    (function(){
      const themeToggle = document.getElementById('themeToggle');
      const LSKEY = 'dtw.theme';
      function applyTheme(mode){
        if (mode === 'light') {
          document.body.classList.add('theme-light');
        } else {
          document.body.classList.remove('theme-light');
        }
      }
      // expose for tests
      window.__applyTheme = applyTheme;

      const saved = localStorage.getItem(LSKEY);
      applyTheme(saved === 'light' ? 'light' : 'dark');
      if (themeToggle){
        themeToggle.checked = (saved === 'light');
        themeToggle.addEventListener('change', ()=>{
          const mode = themeToggle.checked ? 'light' : 'dark';
          localStorage.setItem(LSKEY, mode);
          applyTheme(mode);
        });
      }
    })();

    // Load current on init
    (function init(){
      const savedCurrent = JSON.parse(localStorage.getItem(CURRENT_KEY));
      if (savedCurrent) {
        setCurrentData(savedCurrent);
        testStarted = savedCurrent.testStarted || false;
        updateTable();
        calculateFalls();
        updateDepthTested();
        lengthBottomIndependent = !!savedCurrent.lengthBottom;
        widthBottomIndependent = !!savedCurrent.widthBottom;
        document.getElementById('lengthBottom').value = savedCurrent.lengthBottom || savedCurrent.lengthTop;
        document.getElementById('widthBottom').value = savedCurrent.widthBottom || savedCurrent.widthTop;
        loadTimerState();
        updateUIState();
        checkStartButton();
      }
      loadSavedTests();
      checkStartButton();

      // Auto-save and check start button on parameter changes
      const params = document.querySelectorAll('#parameters input, #parameters select, #parameters textarea');
      params.forEach(el => el.addEventListener('input', () => {
        autoSaveCurrent();
        checkStartButton();
      }));

      // Update depth tested on excavation change
      document.getElementById('depthExcavation').addEventListener('input', () => {
        updateDepthTested();
        autoSaveCurrent();
        checkStartButton();
      });

      // PWA Service Worker
      if ('serviceWorker' in navigator) {
        const swPath = './sw.js';
        window.addEventListener('load', () => {
          navigator.serviceWorker.register(swPath, { scope: './' })
            .then(registration => { console.log('Service Worker registered with scope:', registration.scope); })
            .catch(error => { console.error('Service Worker registration failed:', error.message, 'Path tried:', swPath); });
        });
      }
    })();

    // ---------------- Self-tests (non-intrusive, console only) ----------------
    (function selfTests(){
      try {
        console.group('[DTW Logger] Self-tests');
        let passed = 0, failed = 0;

        // Test 1: CSV builder should include headers and data rows
        const sampleData = {
          locationId: 'TP03', testNumber: 'Test 1', lengthTop: '2000', lengthBottom: '2000', widthTop: '600', widthBottom: '600', depthTested: '250', depthExcavation: '2000', voidRatio: '1', strataDescription: 'Sand over clay', pitDetails: 'Benched'
        };
        const samplePts = [{clockTime:'10:00:00', timeMins:'0.00', depth:100}];
        const csv = buildCSVString(sampleData, samplePts);
        console.assert(csv.includes('Test Parameters'), 'CSV missing header section');
        console.assert(csv.includes('Clock time (local),Time (mins),Depth to water (mm)'), 'CSV missing column header');
        console.assert(csv.includes('10:00:00,0.00,100'), 'CSV missing data row');
        passed += 3;

        // Test 2: Theme toggling adds/removes class
        window.__applyTheme('light');
        console.assert(document.body.classList.contains('theme-light'), 'Light theme not applied');
        window.__applyTheme('dark');
        console.assert(!document.body.classList.contains('theme-light'), 'Dark theme not applied');
        passed += 2;

        // Test 3: Parameters panel class toggling
        const panel = document.getElementById('parameters');
        panel.classList.add('open'); document.body.classList.add('panel-open');
        console.assert(panel.classList.contains('open'), 'Panel did not open');
        panel.classList.remove('open'); document.body.classList.remove('panel-open');
        console.assert(!panel.classList.contains('open'), 'Panel did not close');
        passed += 2;

        // Test 4: Start button enablement logic
        const ids = ['locationId','testNumber','lengthTop','widthTop','depthExcavation'];
        const prev = Object.fromEntries(ids.map(id=>[id, document.getElementById(id).value]));
        document.getElementById('locationId').value = 'TP03';
        document.getElementById('testNumber').value = 'Test 1';
        document.getElementById('lengthTop').value = '2000';
        document.getElementById('widthTop').value = '600';
        document.getElementById('depthExcavation').value = '2000';
        testStarted = false; isPaused = false; startTime = undefined; pausedTime = 0;
        checkStartButton();
        console.assert(!document.getElementById('startPauseBtn').disabled, 'Start button should be enabled when required fields set');
        // restore
        ids.forEach(id=>document.getElementById(id).value = prev[id] || '');
        checkStartButton();
        passed += 1;

        // Test 5: Saved tests label formatting (does not persist)
        const prevStore = localStorage.getItem(STORAGE_KEY);
        const fake = [{ id: '1730000000000', locationId: 'ID-99', testNumber: 'Test Z', savedAt: new Date('2025-01-01T12:00:00Z').toISOString() }];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(fake));
        loadSavedTests();
        const listText = document.getElementById('testsList').textContent;
        console.assert(listText.includes('ID-99 - Test Z'), 'Saved tests label not formatted correctly');
        // restore store
        if (prevStore === null) localStorage.removeItem(STORAGE_KEY); else localStorage.setItem(STORAGE_KEY, prevStore);
        loadSavedTests();
        passed += 1;

        console.log(`Self-tests passed: ${passed}, failed: ${failed}`);
        console.groupEnd();
      } catch (err) {
        console.error('Self-tests error:', err);
      }
    })();
  </script>
</body>
</html>
